#include <ps4/mmap.h>
#include <librop/pthread_create.h>
#include <librop/extcall.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <stddef.h>
#include <unistd.h>
#include <time.h>
typedef int SOCK;

// Automatic New Line Printf Macro
#define nlprintf(fmt, ...) printf("\n"fmt, __VA_ARGS__)
#define nlprintfV2(fmt) printf("\n"fmt)
#define gadgetAddr __builtin_gadget_addr


int initConnection() {
    SOCK conn = socket(AF_INET, SOCK_STREAM, 0);
    if (conn == -1) {
        nlprintf("Error creating socket for conn");
        return 0;
    }
    struct sockaddr_in addr = { 0 };
    addr.sin_family = AF_INET;
    addr.sin_addr.s_addr = 0x100007f; // inet_aton(127.0.0.1)
    addr.sin_port = 0x3d23;// htons(9021)

    if (connect(conn, &addr, sizeof(addr)) == -1) {
        nlprintf("Error occured while trying to connect");
        close(conn); // Close socket if connect fails
        return 0;
    }
    nlprintf("Connection established!");
    return conn;
}

void* sender_thread(void* _) {
    char* miraBlob = gadgetAddr("$(window.mira_blob_2||0)");
    if (miraBlob == NULL) {
        nlprintfV2("miraBlob is NULL");
        return NULL;
    }

    int miraBlobLen = gadgetAddr("$(window.mira_blob_2_len||0)");
    if (miraBlobLen == NULL) {
        nlprintfV2("miraBlobLen is NULL");
        return NULL;
    }

    SOCK conn = initConnection();
    if (conn == 0) return NULL;

    nanosleep("\2\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0", NULL);

    char* outBuffer = miraBlob;
    int bytesLeft = miraBlobLen;
    int bytesWritten = 0;
    while (bytesLeft > 0) {
        if ((bytesWritten = write(conn, outBuffer, bytesLeft)) <= 0)
            break;
        outBuffer += bytesWritten;
        bytesLeft -= bytesWritten;
    }
    if (conn != NULL)close(conn);
    return NULL;
}

int main() {
    if (setuid(0))
        return 1; //jailbreak failed or not run yet
    char* mapping = mmap(NULL, 131072, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    char* mira_blob = __builtin_gadget_addr("$(window.mira_blob||0)");
    if (mira_blob) {
        for (int i = 0; i < 131072; i++)
            mapping[i] = mira_blob[i];
    } else {
        int q = socket(AF_INET, SOCK_STREAM, 0);
        struct sockaddr_in addr = {
            .sin_family = AF_INET,
            .sin_addr = { .s_addr = 0 },
            .sin_port = 0x3c23, // htons(9020)
        };
        bind(q, &addr, sizeof(addr));
        listen(q, 1);
        q = accept(q, NULL, NULL);
        char* x = mapping;
        int l = 131072;
        while (l) {
            int chk = read(q, x, l);
            if (chk <= 0)
                break;
            x += chk;
            l -= chk;
        }
    }
    int sender[512];
    pthread_create(sender, NULL, sender_thread, NULL);
    rop_call_funcptr(mapping);
    return 0;
}
